# ==============================================================================
# Nginx — конфигурация виртуального хоста по умолчанию
# ==============================================================================
# Назначение:
# - Отдаёт статические файлы (HTML, CSS, JS, изображения и т.д.)
# - Проксирует запросы к .php-файлам в PHP-FPM через FastCGI по TCP (порт 9000)
# - Защищает от доступа к служебным файлам (.git, .env и т.д.)
#
# Архитектура:
# - Nginx слушает порт 80, доступен на http://localhost
# - PHP-FPM слушает TCP-порт 9000 внутри Docker-сети (имя сервиса: php-nginx-tcp)
# - Корневая директория (DocumentRoot): /var/www/html
# ==============================================================================

server {
    # Прослушиваем порт 80 (HTTP)
    listen       80;
    server_name  localhost;

    # Корневая директория сайта (DocumentRoot)
    # Должна совпадать с путём в контейнере PHP-FPM для корректной работы SCRIPT_FILENAME
    root   /var/www/html;

    # Индексные файлы: сначала ищем .html, затем .php, затем .htm
    index  index.html index.php index.htm;

    # Логи для отладки и мониторинга
    error_log  /var/log/nginx/error.log warn;
    access_log /var/log/nginx/access.log;

    # --------------------------------------------------------------------------
    # Обработка статических файлов и маршрутизация
    # --------------------------------------------------------------------------
    # Если запрошен файл или директория — отдаём напрямую.
    # Если не найдено — перенаправляем на index.php с сохранением параметров запроса.
    # Это позволяет использовать роутинг через PHP (например, для фреймворков).
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # --------------------------------------------------------------------------
    # Обработка PHP-скриптов через FastCGI (TCP-соединение с PHP-FPM)
    # --------------------------------------------------------------------------
    # Все запросы к файлам с расширением .php проксируются в контейнер PHP-FPM.
    # PHP-FPM слушает TCP-порт 9000 и выполняет PHP-код.
    location ~ \.php$ {
        # Проверяем существование файла, иначе возвращаем 404
        # Это защищает от атаки "PHP CGI Argument Injection"
        try_files $uri =404;

        # Подключаем стандартный набор FastCGI-параметров
        include        fastcgi_params;

        # Адрес PHP-FPM: имя сервиса из docker-compose.yml и порт 9000
        # Важно: используется имя СЕРВИСА (php-nginx-tcp), а не имя контейнера
        fastcgi_pass   php-nginx-tcp:9000;

        # Индексный файл для FastCGI (используется, если запрос к директории)
        fastcgi_index  index.php;

        # --------------------------------------------------------------------------
        # Критически важные параметры для корректной работы PHP
        # --------------------------------------------------------------------------
        # SCRIPT_FILENAME — полный путь к исполняемому PHP-файлу
        # Должен указывать на реальный файл в файловой системе PHP-FPM
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # DOCUMENT_ROOT — корневая директория сайта для PHP
        # Должна совпадать с root в Nginx и с путём монтирования в PHP-FPM
        fastcgi_param  DOCUMENT_ROOT  $document_root;

        # --------------------------------------------------------------------------
        # Таймауты для комфортной разработки и отладки
        # --------------------------------------------------------------------------
        # Увеличенный таймаут ожидания ответа от PHP-FPM (полезно при дебаге с Xdebug)
        fastcgi_read_timeout 120s;

        # Буферы FastCGI (по умолчанию достаточно для большинства случаев)
        # При необходимости можно увеличить fastcgi_buffer_size и fastcgi_buffers
    }

    # --------------------------------------------------------------------------
    # Безопасность: запрет доступа к скрытым файлам
    # --------------------------------------------------------------------------
    # Блокируем доступ к файлам, начинающимся с точки (.git, .env, .htaccess и т.д.)
    # Это предотвращает утечку конфиденциальной информации и конфигураций
    location ~ /\.[^/]+ {
        deny all;
    }

    # --------------------------------------------------------------------------
    # Ограничение размера загружаемых файлов
    # --------------------------------------------------------------------------
    # Согласовано с настройками PHP: upload_max_filesize=20M, post_max_size=20M
    # Если нужно загружать файлы больше 20 МБ — увеличьте это значение и
    # соответствующие параметры в php.ini
    client_max_body_size 20M;
}